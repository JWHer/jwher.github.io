---
layout: post

title: "Dex: OpenID ì»¤ë„¥í„°"  
thumbnail-img: /assets/logos/dex.svg
categories:
- tech
- kubeflow
- kubernetes
excerpt: |
  ìì›ì— OpenID ì¸ì¦ì„ ì œê³µí•˜ëŠ” ë°©ë²•
date: 2021-08-12 23:50:00 

aside: true
feature_text: |
  # A Federated OpenID Connect Provider
feature_image: "/assets/img/bamboos.jpg"
comments: true
---

<p align="center">
<img src="/assets/logos/dex.svg" style="max-height: 40vh;"/>
</p>

*ìì›ì— OpenID ì¸ì¦ì„ ì œê³µí•˜ëŠ” ë°©ë²•*  


# ëª©ì°¨
* [Dex](#dex)
* [ë¡œì»¬ì—ì„œ ì‚¬ìš©í•˜ê¸°](#ë¡œì»¬ì—ì„œ-ì‚¬ìš©í•˜ê¸°)
* [ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ê¸°](#ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ-ì‚¬ìš©í•˜ê¸°)

<!-- more -->
<br/>

## Dex  

### ì‚¬ì „ì§€ì‹

<p align="center">
<img src="/assets/img/dex/social-icons.gif" style="max-height: 40vh;"/>
</p>

ì›¹ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë‹¤ ë³´ë©´ ë‹¤ì–‘í•œ ì†Œì…œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” ê°ê° **[ì¸ê°€(authorization)](https://ko.wikipedia.org/wiki/%EC%9D%B8%EA%B0%80)**
ì™€ **[ì¸ì¦(authentication)](https://ko.wikipedia.org/wiki/%EC%9D%B8%EC%A6%9D)**
ì„ ì œê³µí•˜ëŠ” **OAuth2.0**ê³¼ **OIDC**ë¥¼ ì‚¬ìš©í•´ êµ¬í˜„ë©ë‹ˆë‹¤.

> <div align="center">
> <img src="/assets/logos/Oauth.svg" style="height: 26vmin;"/>
> <img src="/assets/logos/OpenID.svg" style="height: 26vmin;"/><br/>
> ê°‘ìê¸° ì´ê²Œ ë­ì£ ğŸ˜µ
> </div>

### OAuth2.0  
OAuth(Open Authorization)ëŠ” **ì—‘ì„¸ìŠ¤ ê¶Œí•œ**ì„ í™•ì¸í•˜ëŠ” [ê°œë°©í˜• í‘œì¤€](https://ko.wikipedia.org/wiki/%EA%B0%9C%EB%B0%A9%ED%98%95_%ED%91%9C%EC%A4%80) ì…ë‹ˆë‹¤.
ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìê°€ **ì„œë“œíŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜**ì„ ì‚¬ìš©í•´ ìì›ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œ,
ì´ì „ê¹Œì§€ëŠ” í˜ì´ìŠ¤ë¶ê³¼ ê°™ì€ idP(identity Providers)ì˜ **íŒ¨ìŠ¤ì›Œë“œ**ë¥¼ ë„˜ê²¨ ê¶Œí•œì„ í™•ì¸í–ˆìœ¼ë‚˜,
OAuthëŠ” íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ **ì—‘ì„¸ìŠ¤ í† í°**ì„ ë„˜ê²¨ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤.  
  
*ì—‘ì„¸ìŠ¤ í† í°ì€ ëŒ€ê²Œ JWT(JSON Web Token)ë¥¼ ì¿ í‚¤ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤*  

[RFC6749(OAuth 2.0)](https://www.ietf.org/rfc/rfc6749.txt)  
[RFC7519(JWT)](https://www.ietf.org/rfc/rfc7519.txt)  

### OIDC  
OIDC(OpenID Connect)ëŠ” OAuth2.0 ì¸ê°€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¸ì¦ì…ë‹ˆë‹¤.
OIDCë¥¼ ì‚¬ìš©í•´ ì¸ì¦ëœ ì„¸ì…˜ê³¼ **ì‚¬ìš©ì ì •ë³´**ë¥¼ ìš”ì²­/ìˆ˜ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
OIDCëŠ” JSON ë°ì´í„° í˜•ì‹ìœ¼ë¡œ RESTful HTTP APIë¥¼ ì§€ì›í•˜ê³  í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
OAuth2.0 ê¶Œí•œ ì„œë²„ì¸ **OIDC ì œê³µì(OP, OIDC Provider)** ê°€
ì¸ì¦ì´ í•„ìš”í•œ **ì‹ ë¢° ë‹¹ì‚¬ì(RPs, Relying Parties)** ì— ì†Œìœ ê¶Œì„ ì…ì¦í•´ì¤ë‹ˆë‹¤.
ì´ëŠ” ì£¼ë¡œ [í†µí•© ì¸ì¦(SSO, Single Sign-On)](https://ko.wikipedia.org/wiki/%ED%86%B5%ED%95%A9_%EC%9D%B8%EC%A6%9D)
ì„ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.

<details markdown="1">
<summary>OIDC JSON</summary>

```json
{
  "iss": "http://127.0.0.1:5556/dex",
  "sub": "CgcyMzQyNzQ5EgZnaXRodWI",
  "aud": "example-app",
  "exp": 1492882042,
  "iat": 1492795642,
  "at_hash": "bi96gOXZShvlWYtal9Eqiw",
  "email": "jane.doe@coreos.com",
  "email_verified": true,
  "groups": [
    "admins",
    "developers"
  ],
  "name": "Jane Doe"
}
```
</details>
  
[[ì‚¼ì„±]OIDC](https://www.samsungsds.com/kr/insights/oidc.html)  
[RFC6750(OAuth 2.0 Authorization Framework)](https://www.ietf.org/rfc/rfc6750.txt)  

>     +--------+                               +---------------+
>     |        |--(A)- Authorization Request ->|   Resource    |
>     |        |                               |     Owner     |
>     |        |<-(B)-- Authorization Grant ---|               |
>     |        |                               +---------------+
>     |        |
>     |        |                               +---------------+
>     |        |--(C)-- Authorization Grant -->| Authorization |
>     | Client |                               |     Server    |
>     |        |<-(D)----- Access Token -------|               |
>     |        |                               +---------------+
>     |        |
>     |        |                               +---------------+
>     |        |--(E)----- Access Token ------>|    Resource   |
>     |        |                               |     Server    |
>     |        |<-(F)--- Protected Resource ---|               |
>     +--------+                               +---------------+
> RFC6750  
> ì†Œì…œ ë¡œê·¸ì¸ì´ ì´ë ‡ê²Œ ë³µì¡í–ˆêµ°ìš” :sweat:

<br/>

### Dex

> <p align="center">
> <img src="/assets/img/dex/dex-workflow.png" style="max-height: 40vh;"><br/>
> ê°„ëµí™”ëœ íë¦„ë„
> </p>
<details markdown="1">
<summary>ìì„¸í•œ íë¦„</summary>
<img src="/assets/img/dex/oidc_authservice_sequence_diagram.svg" alt="oidc_authservice_sequence_diagram" style="max-height: 40vh;"/>

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ë™ì‘í•˜ëŠ” íë¦„ì…ë‹ˆë‹¤.  
ë¼ìš°í„°ë¡œ Istioë¥¼ ì‚¬ìš©í•˜ê³  ì¸ì¦ ì‹œìŠ¤í…œì´ ì™„ì „íˆ ì—†ëŠ” Client App ì‚¬ì´ì— ë¯¸ë“¤ì›¨ì–´ë¡œ AuthServiceê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
</details>

DexëŠ” OIDCì˜ êµ¬í˜„ìœ¼ë¡œ ì—¬ëŸ¬ idPì˜ ì»¤ë„¥í„°(ì¸í„°í˜ì´ìŠ¤)ì™€ ì—°ê²°í•´ ì¸ì¦ì²˜ë¦¬ë¥¼ ì¤‘ì•™í™”(Federate)í•˜ê³ ,
ì„œë“œíŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¸ì¦ì„ ì œê³µí•©ë‹ˆë‹¤.
ì—¬ê¸°ì„œ idPëŠ” [LDAP](https://ko.wikipedia.org/wiki/LDAP),
[SAML](https://ko.wikipedia.org/wiki/SAML) ë˜ëŠ” GitHub, Google, Naver ë“± ì¡´ì¬í•˜ëŠ” idPì¼ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

## ë¡œì»¬ì—ì„œ ì‚¬ìš©í•˜ê¸°

### ìš”êµ¬ì‚¬í•­
* [ê³ ](https://jwher.github.io/golang-setup) 1.15 ë²„ì „ ì´ìƒ
<!-- * ë˜ëŠ” [ë„ì»¤](https://jwher.github.io/install-docker) -->
<br/>

### ë°”ì´ë„ˆë¦¬

[[ê¹ƒí—™]Dex](https://github.com/dexidp/dex) ì—ì„œ ë±ìŠ¤ ì†ŒìŠ¤ë¥¼ í´ë¡ í•©ë‹ˆë‹¤.
```shell
$ git clone https://github.com/dexidp/dex.git
$ cd dex/
$ make build
```
<br/>

[ì˜ˆì œ ì„¤ì •](https://github.com/dexidp/dex/blob/master/examples/config-dev.yaml)
ì„ ì‚¬ìš©í•´ ì‹¤í–‰í•©ë‹ˆë‹¤. (`examples/` ë””ë ‰í† ë¦¬ì— ìˆìŠµë‹ˆë‹¤)
```shell
./bin/dex serve examples/config-dev.yaml
```
ì˜ˆì œ ì„¤ì •ì˜ ì´ë©”ì¼ì€ `admin@example.com` íŒ¨ìŠ¤ì›Œë“œëŠ” `password`ì…ë‹ˆë‹¤.
(ì„¤ì²­ì—ëŠ” bcrypt hash ê°’ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.)
<br/>

ì´ì œ ë±ìŠ¤ OIDC ì¸ì¦ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ì˜ˆì œ í´ë¼ì´ì–¸íŠ¸ ì•±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
```shell
$ make examples
$ ./bin/examples-app
```
<br/>

ì˜ˆì œ í´ë¼ì´ì–¸íŠ¸ ì•±ì— ë±ìŠ¤ë¡œ ë¡œê·¸ì¸í•˜ëŠ” ì ˆì°¨ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
<p>1. http://localhost:5555/ ì˜ ì˜ˆì œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>  
<br/>
<p align="center">
<img src="/assets/img/dex/example-login.png" alt="example-login" style="max-height: 40vh;"/>
</p>
<p>2. `login` ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤. (ì—¬ëŸ¬ ì…ë ¥ì°½ì´ ìˆì§€ë§Œ ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤)</p>

*ì£¼ì˜! í˜„ì¬ ë²„ê·¸ê°€ ìˆëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤(21.08.12) ì´ë™í•˜ëŠ” ë§í¬
(http://127.0.0.1:5556/dex/auth?client_id=example-app&redirect_uri=http%3A%2F%2F127.0.0.1%3A5555%2Fcallback&response_type=code&scope=openid+profile+email+offline_access&state=I+wish+to+wash+my+irish+wristwatch)
ì˜ `127.0.0.1`ì„ `localhost`ë¡œ ë³€ê²½í•´ì•¼ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.*
<br/>
<p>3. `examples/config-dev.yaml`ì— ì„¤ì •í•œ ì´ë©”ì¼ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. (`admin@example.com`, `password`)</p>
<br/>
<p align="center">
<img src="/assets/img/dex/example-grant.png" alt="example-grant" style="max-height: 40vh;"/>
</p>
<p>4. ì˜ˆì œ ì•± ìš”ì²­ì„ ìŠ¹ì¸í•©ë‹ˆë‹¤.</p>
<br/>
<p align="center">
<img src="/assets/img/dex/example-token.png" alt="example-token" style="max-height: 40vh;"/>
</p>
<p>5. ì˜ˆì œ ì•±ì´ ë±ìŠ¤ì— ìš”êµ¬í•˜ëŠ” tokenì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
<br/>

### LDAP

LDAP configì…ë‹ˆë‹¤. ë‚˜ì¤‘ì— ê¸€ì„ ë³´ì™„í•˜ê² ìŠµë‹ˆë‹¤.  
[[ê³µì‹]Authentication Through LDAP](https://dexidp.io/docs/connectors/ldap/)
<details markdown="1">
<summary>ldap.yaml</summary>

```yaml
issuer: http://127.0.0.1:5556/dex
storage:
  type: sqlite3
  config:
    file: examples/dex.db
web:
  http: 0.0.0.0:5556

connectors:
- type: ldap
  name: OpenLDAP
  id: ldap
  config:
    # The following configurations seem to work with OpenLDAP:
    #
    # 1) Plain LDAP, without TLS:
    host: your-ldap-address:389
    insecureNoSSL: true
    
    # 2) LDAPS without certificate validation:
    #host: localhost:636
    #insecureNoSSL: false
    #insecureSkipVerify: true
  
    # 3) LDAPS with certificate validation:
    #host: YOUR-HOSTNAME:636
    #insecureNoSSL: false
    #insecureSkipVerify: false
    #rootCAData: 'CERT'
    # ...where CERT="$( base64 -w 0 your-cert.crt )"

    # This would normally be a read-only user.
    bindDN: cn="",dc="",dc="",dc=""
    bindPW: your-password

    # dex UIì— ë³´ì—¬ì§€ëŠ” ì…ë ¥ì°½
    usernamePrompt: Username

    userSearch:
      baseDN: ou="",dc="",dc="",dc=""
      #filter: "(objectClass=person)"
      # LDAP ì¡°íšŒì‹œ ì‚¬ìš©ë˜ëŠ” ID
      username: uid
      # "DN" (case sensitive) is a special attribute name. It indicates that
      # this value should be taken from the entity's DN not an attribute on
      # the entity.
      idAttr: uid
      emailAttr: mail
      nameAttr: gecos

      #groupSearch:
      #baseDN: ou=Groups,dc=example,dc=org
      #filter: "(objectClass=groupOfNames)"

      #userMatchers:
        # A user is a member of a group when their DN matches
        # the value of a "member" attribute on the group entity.
        #- userAttr: DN
        #groupAttr: member

      # The group name should be the "cn" value.
      #nameAttr: cn

staticClients:
- id: example-app
  redirectURIs:
  - 'http://127.0.0.1:5555/callback'
  name: 'Example App'
  secret: ZXhhbXBsZS1hcHAtc2VjcmV0
```
</details>
<br/>

## ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ê¸°

ë‚˜ì¤‘ì— ì¶”ê°€ë¡œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.  
deployment ì‘ì„±
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dex
  name: dex
  namespace: auth
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dex
  template:
    metadata:
      labels:
        app: dex
    spec:
      containers:
      - command:
        - dex
        - serve
        - /etc/dex/cfg/config.yaml
        image: quay.io/dexidp/dex:v2.22.0
        imagePullPolicy: IfNotPresent
        name: dex
        ports:
        - containerPort: 5556
          name: http
          protocol: TCP
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/dex/cfg
          name: config
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: dex
      serviceAccountName: dex
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: config.yaml
            path: config.yaml
          name: dex
        name: config
```

configmap ì‘ì„±
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dex
  namespace: auth
data:
  config.yaml: |
    issuer: http://dex.auth.svc.cluster.local:5556/dex
    storage:
      type: kubernetes
      config:
        inCluster: true
    web:
      http: 0.0.0.0:5556
    logger:
      level: "debug"
      format: text
    oauth2:
      skipApprovalScreen: true
    enablePasswordDB: true
    staticPasswords:
    - email: admin@example.com
      hash: $2y$12$ruoM7FqXrpVgaol44eRZW.4HWS8SAvg6KYVVSCIwKQPBmTpCm.EeO
      username: admin
      userID: 08a8684b-db88-4b73-90a9-3cd1661f5466
    staticClients:
    - id: oidc-authservice
      redirectURIs: ["/login/oidc"]
      name: 'Dex Login Application'
      secret: pUBnBOY80SnXgjibTYM9ZWNzY2xreNGQok
```

<br/>

## Tips

ìš©ë‘ì‚¬ë¯¸ë„¤ìš”... (ì‹œê°„ì´ ë” ìˆì—ˆìœ¼ë©´..)

### Reference  

[[ìœ„í‚¤]OAuth](https://en.wikipedia.org/wiki/OAuth)  
[[IBM]OAuth2.0 ê°œë…](https://www.ibm.com/docs/ko/sva/9.0.7?topic=SSPREK_9.0.7/com.ibm.isam.doc/config/concept/con_oauth_20_concepts.html#con_oauth_20_concepts)  
[[ìœ„í‚¤]OpenID](https://en.wikipedia.org/wiki/OpenID#OpenID_Connect_(OIDC))  
[[IBM]OpenID Connect ê°œë…](https://www.ibm.com/docs/ko/sva/9.0.7?topic=concepts-openid-connect)   

[[ê³µì‹]Dex](https://dexidp.io/)  

## - JWHer  
ì¢‹ì€ ê¸€ì„ ì“°ê³  ì‹¶ìŠµë‹ˆë‹¤.

<!-- update log -->
<!--
ë³¸ë¬¸ì— ì¶”ê°€í•  ë‚´ìš©ì„ ì ëŠ”ë‹¤.
https://lcc3108.github.io/articles/2020-12/Istio+Dex-%EC%9D%B8%EC%A6%9D#dex

-->